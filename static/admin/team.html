<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/layui/css/layui.css"/>
    <link href="/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/index.css"/>
</head>
<body class="main-body-admin">
<nav style="margin-top: 10px;">
    <button class="layui-btn" onclick="add()">新增</button>
    <button class="layui-btn" onclick="edit()">编辑</button>
    <button class="layui-btn layui-btn-danger" onclick="deleteRow()">删除</button>
    <input class="layui-input-inline" id="searchValue"/>
    <button class="layui-btn layui-btn-normal" onclick="search()">搜索</button>
</nav>
<table id="team" lay-filter="test"></table>
<script src="/js/jquery.min.js"></script>
<script src="/js/config/server.js"></script>
<script src="/js/common/login.js"></script>
<script src="/js/common/upload.js"></script>
<script src="/layui/layui.all.js"></script>
<script>
  var table;
  var index = layer.load(2, {time: 2*1000});
  handlerGet('/common/ping', 'admin', function () {
    layui.use('table', function () {
      table = layui.table;
      table.render({
        elem: '#team'
        , height: 515
        , url: host + '/rest/team/listAll' //数据接口
        , page: true //开启分页
        , limit: 15
        , limits : [15, 30, 45]
        , cols: [[ //表头
          {checkbox: true}
          , {field: 'teamId', title: 'ID', width: 160, sort: true}
          , {field: 'name', title: '团队名', width: 120}
          , {field: 'majorId', title: '所属专业', width: 120, templet : function (data) {
              var result = '暂无';
              if(data.majorId === 'null'){
                return result;
              }else{
                handlerGetSync('/rest/major/'+data.majorId, 'admin', function (data) {
                  result = data.data.name;
                });
                return result;
              }
            }}
          , {field: 'judgeTeamId', title: '评委团队', width: 120, templet: function (data) {
              var result = '暂无';
              if(data.judgeTeamId === 'null'){
                return result;
              }else{
                handlerGetSync('/rest/team/'+data.judgeTeamId, 'admin', function (data) {
                  result = data.data.name;
                });
                return result;
              }
            }}
          , {field: 'leaderId', title: '负责人', width: 120, templet: function (data) {
              var result = '暂无';
              if(data.leaderId === 'null'){
                return result;
              }else{
                handlerGetSync('/rest/teacher/'+data.leaderId, 'admin', function (data) {
                  result = data.data.username;
                });
                return result;
              }
            }}
          , {field: 'assistantId', title: '答辩秘书', width: 120, templet: function (data) {
              if(data.assistantId === 'null'){
                return "暂无";
              }else{
                handlerGetSync('/rest/teacher/'+data.assistantId, 'admin', function (data) {
                  result = data.data.username;
                });
                return result;
              }
            }}
          , {field: 'year', title: '毕业届数', width: 120}
        ]]
      });
    });
  }, function (data) {
    layer.msg('请检查网络并重试'+data.responseText)
  });
  function deleteRow() {
    var checkStatus = table.checkStatus('team');
    layer.confirm('确认删除这些数据', {icon: 3, title: '提示'}, function (index) {
      var idList = '';
      checkStatus.data.forEach(function (item) {
        idList += item.teamId + delimiter_num;
      });
      handlerDelete('/rest/team', 'admin', idList, function (data) {
        if (data.code === "0") {
          layer.msg("删除成功");
          reloadAll()
        }
      }, function (data) {
        console.log(data)
      });
      layer.close(index);
    });
  }

  function reloadAll() {
    layui.use('table', function () {
      var table = layui.table;
      table.reload('team', {
        url: host + '/rest/team/listAll'
      });
    })
  }

  function updateValue(content, name, value) {
    return content.replace(name + '##VA', value)
  }

  function edit() {
    var checkStatus = table.checkStatus('team');
    if(checkStatus.data.length !== 1){
      layer.msg('请选择一条记录')
    }else{
      var content = $('#editData').html();
      handlerGet('/rest/team/'+checkStatus.data[0].teamId, 'admin', function (data) {
        content = updateValue(content, 'name', data.data.name);
        tips(content, '编辑数据', function () {
          var mainData = {
            teamId: checkStatus.data[0].teamId,
            name: $("#name").val()
          };
          console.log(JSON.stringify(mainData));
          handlerPost('/rest/team', 'admin', JSON.stringify(mainData), function (data) {
            reloadAll();
            layer.msg('配置保存成功')
          }, function (data) {
            layer.msg('保存失败')
          });
        });
      }, function (data) {
        layer.msg('发生错误'+data.msg);
      });
    }
  }

  function add() {
    var content = $('#editData').html();
    content = updateValue(content, 'name', '');
    tips(content, '新增数据', function () {
      var mainData = {
        name: $("#name").val()
      };
      console.log(JSON.stringify(mainData));
      handlerPost('/rest/team', 'admin', JSON.stringify(mainData), function (data) {
        reloadAll();
        layer.msg('配置保存成功')
      }, function (data) {
        layer.msg('保存失败')
      });
    });
  }

  function tips(content, title, confirm) {
    layer.open({
      title: title
      , content: content
      , btnAlign: 'c'
      , resize: true
      , area: ['300px', '200px']
      , btn: ['确认', '取消']
      , yes: function (index, layero) {
        confirm();
      },
      cancel: function () {
      }
    });
  }
  function search() {
    var value = $("#searchValue").val();
    if (value === '' || value === ' ') {
      layer.msg('请输入查询参数');
      return;
    }
    layui.use('table', function () {
      var table = layui.table;
      table.reload('team', {
        url: host+'/rest/team/search?name=' + value+''
        , where: {}
      });
    })
  }
</script>
<script id="editData" type="text/html">
    <div id="Tips">
        <label for="name">学院名</label>
        <input name="name" type="text" id="name" value="name##VA" required/>
    </div>
</script>

<script id="loadFromExcel" type="text/html">
    <div>
        <input type="file" id="selectFile" />
        <progress id="progressBar" value="0" max="100"></progress>
        <span id="percentage"></span>
    </div>
</script>
</body>
</html>